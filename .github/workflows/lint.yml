name: Lint

on:
  push:
    branches: [main]
  pull_request:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run linter
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.7.2

  verify-codegen:
    name: Verify Code Generation
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Cache tool binaries
        uses: actions/cache@v4
        with:
          path: bin
          key: tools-${{ runner.os }}-${{ hashFiles('Makefile') }}

      - name: Verify manifests and generated code are up to date
        run: |
          make manifests generate
          git diff --exit-code config/ api/

  helm-docs:
    name: Helm Docs
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Install helm-docs
        run: |
          HELM_DOCS_VERSION=v1.14.2
          curl -fsSL "https://github.com/norwoodj/helm-docs/releases/download/${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION#v}_Linux_x86_64.tar.gz" \
            | tar xz -C /usr/local/bin helm-docs

      - name: Verify chart README is up to date
        run: |
          helm-docs --chart-search-root charts
          git diff --exit-code charts/
