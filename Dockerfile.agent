# Build the sync agent binary
FROM golang:1.25 AS builder
ARG TARGETOS
ARG TARGETARCH

WORKDIR /workspace
COPY go.mod go.mod
COPY go.sum go.sum
RUN go mod download

COPY . .

ARG VERSION=dev
RUN CGO_ENABLED=0 GOOS=${TARGETOS:-linux} GOARCH=${TARGETARCH} \
    go build -a -ldflags "-X github.com/ia-eknorr/stoker-operator/internal/agent.agentVersion=${VERSION}" \
    -o agent cmd/agent/main.go

# Alpine with git and openssh â€” no shell session risk with readOnlyRootFilesystem
FROM alpine:3.21
RUN apk add --no-cache git openssh-client nss_wrapper
WORKDIR /
COPY --from=builder /workspace/agent .
USER 65534:65534
EXPOSE 8082 8083

ENTRYPOINT ["/agent"]
