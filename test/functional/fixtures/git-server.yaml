---
apiVersion: v1
kind: Pod
metadata:
  name: test-git-server
  labels:
    app: test-git-server
spec:
  initContainers:
    - name: init-repo
      image: alpine:3.20
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          apk add --no-cache git
          mkdir -p /git/test-repo.git

          # Create a temp working directory
          cd /tmp
          git init -b main test-repo
          cd test-repo
          git config user.email "test@test.local"
          git config user.name "Test"

          # Create realistic Ignition project structure
          mkdir -p com.inductiveautomation.ignition/projects/MyProject/com.inductiveautomation.perspective/views/MainView
          mkdir -p com.inductiveautomation.ignition/projects/SharedScripts
          mkdir -p tags/default
          mkdir -p .resources

          cat > com.inductiveautomation.ignition/projects/MyProject/project.json <<'PROJEOF'
          {
            "title": "MyProject",
            "description": "Test project for functional tests",
            "enabled": true,
            "inheritable": false
          }
          PROJEOF

          cat > com.inductiveautomation.ignition/projects/MyProject/com.inductiveautomation.perspective/views/MainView/view.json <<'VIEWEOF'
          {
            "custom": {},
            "params": {},
            "root": {
              "type": "ia.container.flex",
              "children": []
            }
          }
          VIEWEOF

          cat > com.inductiveautomation.ignition/projects/SharedScripts/project.json <<'SSEOF'
          {
            "title": "SharedScripts",
            "description": "Shared script library",
            "enabled": true,
            "inheritable": true
          }
          SSEOF

          cat > tags/default/tags.json <<'TAGEOF'
          {
            "tags": [
              {
                "name": "TestTag",
                "tagType": "AtomicTag",
                "valueSource": "memory",
                "value": 0,
                "dataType": "Int4"
              }
            ]
          }
          TAGEOF

          cat > .resources/platform_state.json <<'PLATEOF'
          {
            "version": "8.1.44",
            "systemName": "default"
          }
          PLATEOF

          git add -A
          git commit -m "initial"
          git tag v1.0.0

          # Second commit â€” add a new view
          mkdir -p com.inductiveautomation.ignition/projects/MyProject/com.inductiveautomation.perspective/views/SecondView
          cat > com.inductiveautomation.ignition/projects/MyProject/com.inductiveautomation.perspective/views/SecondView/view.json <<'V2EOF'
          {
            "custom": {},
            "params": {},
            "root": {
              "type": "ia.display.label",
              "props": { "text": "Hello from v2" }
            }
          }
          V2EOF

          git add -A
          git commit -m "add second view"
          git tag v2.0.0

          # Push into bare repo
          cd /tmp
          git clone --bare test-repo /git/test-repo.git
          cd /git/test-repo.git
          git update-server-info

          echo "Git repo initialized successfully"
      volumeMounts:
        - name: git-data
          mountPath: /git
  containers:
    - name: git-daemon
      image: alpine:3.20
      command: ["/bin/sh", "-c"]
      args:
        - |
          apk add --no-cache git git-daemon &&
          git daemon --verbose --export-all --enable=receive-pack --base-path=/git /git
      ports:
        - containerPort: 9418
          name: git
          protocol: TCP
      volumeMounts:
        - name: git-data
          mountPath: /git
      readinessProbe:
        tcpSocket:
          port: 9418
        initialDelaySeconds: 2
        periodSeconds: 5
  volumes:
    - name: git-data
      emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: test-git-server
spec:
  selector:
    app: test-git-server
  ports:
    - port: 9418
      targetPort: 9418
      protocol: TCP
  type: ClusterIP
